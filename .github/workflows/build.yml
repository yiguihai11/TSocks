name: Android CI Build

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.3'

    - name: Cache NDK
      uses: actions/cache@v4
      with:
        path: android-ndk-r27d
        key: ndk-r27d-${{ runner.os }}
        restore-keys: ndk-r27d-

    - name: Download and set up Android NDK
      run: |
        if [ ! -d "android-ndk-r27d" ]; then
          echo "NDK directory not found, downloading..."
          sudo apt-get update -y
          sudo apt-get install -y wget unzip
          wget https://dl.google.com/android/repository/android-ndk-r27d-linux.zip
          unzip -o -q android-ndk-r27d-linux.zip
        else
          echo "NDK directory found from cache, skipping download"
        fi
        echo "ANDROID_NDK_HOME=$GITHUB_WORKSPACE/android-ndk-r27d" >> $GITHUB_ENV

    - name: Grant execute permission to gradlew
      run: chmod +x gradlew

    - name: Set up Gradle
      uses: gradle/actions/setup-gradle@v5
      with:
        gradle-version: 8.7
        cache-read-only: false

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          gradle-${{ runner.os }}-

    - name: Clean Gradle cache and build
      run: gradle clean

    - name: Build Go native libraries
      run: gradle buildGoLibs --no-daemon --no-build-cache

    - name: Build Android APK
      run: gradle assembleDebug --no-daemon --no-build-cache

    - name: Create upload directories
      run: |
        mkdir -p upload/{arm64,arm32,x64,x86}
        cp app/build/outputs/apk/debug/app-arm64-v8a-debug.apk upload/arm64/ 2>/dev/null || echo "ARM64 APK not found"
        cp app/build/outputs/apk/debug/app-armeabi-v7a-debug.apk upload/arm32/ 2>/dev/null || echo "ARM32 APK not found"
        cp app/build/outputs/apk/debug/app-x86_64-debug.apk upload/x64/ 2>/dev/null || echo "x64 APK not found"
        cp app/build/outputs/apk/debug/app-x86-debug.apk upload/x86/ 2>/dev/null || echo "x86 APK not found"

    - name: Create architecture info file
      run: |
        echo '# TSocks APK Downloads' > upload/README.md
        echo '' >> upload/README.md
        echo '## Choose the right APK version' >> upload/README.md
        echo '' >> upload/README.md
        echo '### Mobile Devices' >> upload/README.md
        echo '- ARM64 (recommended): arm64/ - Modern Android devices (2018+)' >> upload/README.md
        echo '- ARM32: arm32/ - Older Android devices (pre-2018)' >> upload/README.md
        echo '' >> upload/README.md
        echo '### Emulators/PC' >> upload/README.md
        echo '- x64: x64/ - 64-bit emulators or PC' >> upload/README.md
        echo '- x86: x86/ - 32-bit emulators or PC' >> upload/README.md
        echo '' >> upload/README.md
        echo '## How to choose?' >> upload/README.md
        echo '1. Not sure about device architecture? Choose ARM64 (best compatibility)' >> upload/README.md
        echo '2. Check device settings to About phone to Processor architecture' >> upload/README.md
        echo '3. Use command: adb shell getprop ro.product.cpu.abi' >> upload/README.md
        echo '' >> upload/README.md
        echo '## File details' >> upload/README.md
        echo '- Each APK contains native libraries for corresponding architecture only' >> upload/README.md
        echo '- File size: ~3-4MB per APK' >> upload/README.md
        echo '- Supports Android 7.0+ (API 26+)' >> upload/README.md
        echo '' >> upload/README.md
        echo "Build: ${{ github.sha }}" >> upload/README.md
        echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> upload/README.md

    - name: Upload ARM64 APK (most devices)
      uses: actions/upload-artifact@v4
      if: hashFiles('upload/arm64/*.apk') != ''
      with:
        name: tsocks-arm64-v8a
        path: upload/arm64/
        retention-days: 30

    - name: Upload ARM32 APK (older devices)
      uses: actions/upload-artifact@v4
      if: hashFiles('upload/arm32/*.apk') != ''
      with:
        name: tsocks-armeabi-v7a
        path: upload/arm32/
        retention-days: 30

    - name: Upload x64 APK (emulators)
      uses: actions/upload-artifact@v4
      if: hashFiles('upload/x64/*.apk') != ''
      with:
        name: tsocks-x86_64
        path: upload/x64/
        retention-days: 30

    - name: Upload x86 APK (32-bit)
      uses: actions/upload-artifact@v4
      if: hashFiles('upload/x86/*.apk') != ''
      with:
        name: tsocks-x86
        path: upload/x86/
        retention-days: 30

    - name: Build summary
      run: |
        echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Architecture | APK File | Size | Target Devices |" >> $GITHUB_STEP_SUMMARY
        echo "|--------------|----------|------|----------------|" >> $GITHUB_STEP_SUMMARY

        for arch in arm64 arm32 x64 x86; do
          if [ -f "upload/$arch"/*.apk ]; then
            size=$(du -h "upload/$arch"/*.apk | cut -f1)
            apk_name=$(basename upload/$arch/*.apk)

            case $arch in
              arm64) desc="çŽ°ä»£æ‰‹æœº (æŽ¨è)" ;;
              arm32) desc="æ—§æ‰‹æœº" ;;
              x64) desc="64ä½æ¨¡æ‹Ÿå™¨" ;;
              x86) desc="32ä½æ¨¡æ‹Ÿå™¨" ;;
            esac

            echo "| $arch | $apk_name | $size | $desc |" >> $GITHUB_STEP_SUMMARY
          fi
        done

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **ä¸‹è½½å»ºè®®**: å¤§å¤šæ•°ç”¨æˆ·é€‰æ‹© `tsocks-arm64-v8a`" >> $GITHUB_STEP_SUMMARY